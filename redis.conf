# ================================
# Redis Configuration for Chat Application
# Optimized for Message Queue with Persistence
# ================================

# ================================
# PERSISTENCE (CRITICAL FOR MESSAGE INTEGRITY!)
# ================================

# AOF (Append-Only File) - Primary persistence method
appendonly yes
appendfilename "appendonly.aof"

# AOF sync strategy:
# - always: Safest but slowest (sync every write)
# - everysec: Good balance (sync every second) - RECOMMENDED
# - no: Fastest but risky (let OS decide when to sync)
appendfsync everysec

# Rewrite AOF when it grows too large
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# RDB (Snapshot) - Secondary persistence method
save 900 1      # Save if at least 1 key changed in 900 seconds (15 min)
save 300 10     # Save if at least 10 keys changed in 300 seconds (5 min)
save 60 10000   # Save if at least 10000 keys changed in 60 seconds (1 min)

# RDB filename
dbfilename dump.rdb

# Directory for both AOF and RDB files
dir /data

# ================================
# MEMORY MANAGEMENT
# ================================

# Maximum memory (adjust based on your server)
maxmemory 2gb

# Eviction policy - IMPORTANT: Never evict queue data!
# noeviction: Return error when memory limit reached (RECOMMENDED for queues)
maxmemory-policy noeviction

# ================================
# NETWORK
# ================================

# Bind to all interfaces (Docker networking)
bind 0.0.0.0

# Protected mode (disable in Docker with proper network isolation)
protected-mode no

# Port
port 6379

# TCP backlog
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

# Timeout (0 = disable)
timeout 0

# ================================
# PERFORMANCE
# ================================

# Enable threading (Redis 6+)
# io-threads 4
# io-threads-do-reads yes

# Disable slow log (or configure threshold)
slowlog-log-slower-than 10000
slowlog-max-len 128

# ================================
# LOGGING
# ================================

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (empty string = stdout, good for Docker)
logfile ""

# ================================
# SECURITY
# ================================

# Require password (uncomment and set in production)
# requirepass your_strong_password_here

# Rename dangerous commands (optional, for production)
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG ""

# ================================
# ADVANCED
# ================================

# Disable RDB on BGSAVE failure (don't stop AOF)
stop-writes-on-bgsave-error no

# RDB compression
rdbcompression yes
rdbchecksum yes

# AOF loading truncated file
aof-load-truncated yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# ================================
# BULLMQ OPTIMIZATION
# ================================

# Ensure lists (used by BullMQ) are not evicted
# maxmemory-policy already set to noeviction

# Disable active defragmentation (may interfere with queue operations)
# activedefrag no

# ================================
# CLIENT OUTPUT BUFFER LIMITS
# ================================

# Normal clients
client-output-buffer-limit normal 0 0 0

# Pub/Sub clients
client-output-buffer-limit pubsub 32mb 8mb 60

# Replica clients
client-output-buffer-limit replica 256mb 64mb 60

